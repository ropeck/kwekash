#!/bin/bash

NAMESPACE="weka-operator-system"
KUBECONFIG_PATH=""

# Parse kubeconfig option manually
if [[ "$1" == "--kubeconfig" ]]; then
  shift
  if [[ -z "$1" ]]; then
    echo "‚ùå Error: --kubeconfig requires a path argument."
    exit 1
  fi
  KUBECONFIG_PATH="$1"
  shift
elif [[ -n "$KUBECONFIG" ]]; then
  KUBECONFIG_PATH="$KUBECONFIG"
else
  echo "‚ùå Error: KUBECONFIG is not set and --kubeconfig was not provided."
  exit 1
fi

# Use kubecolor if available, fallback to kubectl
KUBECMD=$(command -v kubecolor || echo "kubectl")
KUBECTL="$KUBECMD --kubeconfig $KUBECONFIG_PATH"

# Get the pod name
POD=$($KUBECTL get pods -n "$NAMESPACE" | grep -m1 drive | awk '{print $1}')

usage() {
  echo "Usage: kwekash [--kubeconfig <path>] [-it] [watch [watch-options] weka-subcommand]..."
  echo ""
  echo "Examples:"
  echo "  kwekash --kubeconfig ~/.kube/devconfig         # Use alternate kubeconfig"
  echo "  kwekash                                        # Run 'weka status' on the pod"
  echo "  kwekash -it                                    # Open interactive shell"
  echo "  kwekash watch status                           # Run 'watch weka status'"
  echo "  kwekash watch -n 2 local ps                    # Run 'watch -n 2 weka local ps'"
  echo "  kwekash --help                                 # Show this help"
}

if [[ "$1" == "--help" ]]; then
  usage
  exit 0
fi

echo "üîç Using pod: $POD in namespace: $NAMESPACE"
echo "üìÅ Using kubeconfig: $KUBECONFIG_PATH"

if [[ "$1" == "-it" ]]; then
  echo "üîß Running: $KUBECTL exec -it -n $NAMESPACE $POD -- bash"
  $KUBECTL exec -it -n "$NAMESPACE" "$POD" -- bash

elif [[ "$1" == "watch" ]]; then
  shift
  WATCH_OPTS=()
  WEKA_ARGS=()

  while [[ $# -gt 0 ]]; do
    case "$1" in
      -*) WATCH_OPTS+=("$1"); shift ;;
      *) WEKA_ARGS+=("$1"); shift ;;
    esac
  done

  echo "üîß Running: $KUBECTL exec -it -n $NAMESPACE $POD -- watch ${WATCH_OPTS[*]} weka ${WEKA_ARGS[*]}"
  $KUBECTL exec -it -n "$NAMESPACE" "$POD" -- watch "${WATCH_OPTS[@]}" weka "${WEKA_ARGS[@]}"

elif [ $# -eq 0 ]; then
  echo "üîß Running: $KUBECTL exec -n $NAMESPACE $POD -- weka status"
  $KUBECTL exec -n "$NAMESPACE" "$POD" -- weka status

else
  echo "üîß Running: $KUBECTL exec -n $NAMESPACE $POD -- weka $*"
  $KUBECTL exec -n "$NAMESPACE" "$POD" -- weka "$@"
fi
