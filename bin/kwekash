#!/bin/bash

NAMESPACE="weka-operator-system"
POD_MATCH="drive"
KUBECONFIG_PATH=""
ARGS=()

usage() {
  echo "Usage: kwekash [--kubeconfig <path>] [--namespace <ns>] [--pod <pattern>] [-it] [watch [watch-options]] [weka-subcommand]..."
  echo ""
  echo "Examples:"
  echo "  kwekash                                         # Run 'weka status' on the pod (default)"
  echo "  kwekash -it                                     # Open interactive shell on first matching pod"
  echo "  kwekash status                                  # Run 'weka status'"
  echo "  kwekash local ps                                # Run 'weka local ps'"
  echo "  kwekash watch status                            # Watch 'weka status'"
  echo "  kwekash --pod compute status                    # Show status on compute pod"
  echo "  kwekash --kubeconfig ~/.kube/dev.yaml           # Use alternate kubeconfig"
  echo "  kwekash --help                                  # Show this help"
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    --kubeconfig)
      shift; KUBECONFIG_PATH="$1"; shift ;;
    --namespace)
      shift; NAMESPACE="$1"; shift ;;
    --pod)
      shift; POD_MATCH="$1"; shift ;;
    --help)
      usage; exit 0 ;;
    *)
      ARGS+=("$1"); shift ;;
  esac
done

if [[ -z "$KUBECONFIG_PATH" ]]; then
  if [[ -n "$KUBECONFIG" ]]; then
    KUBECONFIG_PATH="$KUBECONFIG"
  else
    echo "‚ùå Error: KUBECONFIG is not set and --kubeconfig was not provided."
    exit 1
  fi
fi

KUBECMD=$(command -v kubecolor || echo "kubectl")
KUBECTL="$KUBECMD --kubeconfig $KUBECONFIG_PATH"
POD=$($KUBECTL get pods -n "$NAMESPACE" | grep -m1 "$POD_MATCH" | awk '{print $1}')

echo "üîç Using pod: $POD in namespace: $NAMESPACE"
echo "üìÅ Using kubeconfig: $KUBECONFIG_PATH"

if [[ "${ARGS[0]}" == "-it" ]]; then
  echo "üîß Running: $KUBECTL exec -it -n $NAMESPACE $POD -- bash"
  $KUBECTL exec -it -n "$NAMESPACE" "$POD" -- bash

elif [[ "${ARGS[0]}" == "watch" ]]; then
  WATCH_OPTS=()
  WEKA_ARGS=()
  shift_args=("${ARGS[@]:1}")

  for arg in "${shift_args[@]}"; do
    case "$arg" in
      -*) WATCH_OPTS+=("$arg") ;;
      *) WEKA_ARGS+=("$arg") ;;
    esac
  done

  echo "üîß Running: $KUBECTL exec -it -n $NAMESPACE $POD -- watch ${WATCH_OPTS[*]} weka ${WEKA_ARGS[*]}"
  $KUBECTL exec -it -n "$NAMESPACE" "$POD" -- watch "${WATCH_OPTS[@]}" weka "${WEKA_ARGS[@]}"

elif [[ ${#ARGS[@]} -eq 0 ]]; then
  echo "üîß Running: $KUBECTL exec -n $NAMESPACE $POD -- weka status"
  $KUBECTL exec -n "$NAMESPACE" "$POD" -- weka status

else
  echo "üîß Running: $KUBECTL exec -n $NAMESPACE $POD -- weka ${ARGS[*]}"
  $KUBECTL exec -n "$NAMESPACE" "$POD" -- weka "${ARGS[@]}"
fi
